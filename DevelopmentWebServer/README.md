# Resolving Deep Linking Registration Failures

Unfortunately, it can be difficult for developers to share working code samples that use deep linking.\
This can prevent my app from running, and there are two resolutions.

## Easy Fix

The easy fix to get a working app you can switch to a private URI scheme redirect URI.\
To do so, update the `mobile_config.json` file with the following content:

```json
{
  "app": {
    "apiBaseUrl":             "https://api.authsamples.com/investments"
  },
  "oauth": {
    "authority":              "https://cognito-idp.eu-west-2.amazonaws.com/eu-west-2_CuhLeqiE9",
    "userInfoEndpoint":       "https://login.authsamples.com/oauth2/userInfo",
    "clientId":               "2vshs4gidsbpnjmsprhh607ege",
    "webBaseUrl":             "com.authsamples.basicmobileapp",
    "loginRedirectPath":      ":/callback",
    "postLogoutRedirectPath": ":/logoutcallback",
    "deepLinkBaseUrl":        "com.authsamples.basicmobileapp",
    "loginActivatePath":      "/basicmobileapp/oauth/callback",
    "postLogoutActivatePath": "/basicmobileapp/oauth/logoutcallback",
    "scope":                  "openid profile https://api.authsamples.com/investments",
    "customLogoutEndpoint":   "https://login.authsamples.com/logout"
  }
}
```

## Difficult Fix

The difficult fix enables you to run the app in my intended manner, using claimed HTTPS scheme redirect URIs on a simulator.\
This requires you to use code signing and host your own deep linking assets file.\
Start by adding this entry to the hosts file on your MacBook:

```text
127.0.0.1 mobile.authsamples.com
```

Then run a local web server that hosts the deep linking assets file over HTTPS by running this script on your MacBook.\
You must have Node.js 20+ and OpenSSL 3 installed, and supply your Apple Team ID to the script:

```bash
export APPLE_TEAM_ID='U3VTCHYEM7'
./DevelopmentWebServer/run.sh
```

On the MacBook you can then verify that the deep linking assets file is being served correctly:

```bash
curl -i -k https://mobile.authsamples.com/.well-known/apple-app-site-association
```

Sign into Xcode with your own Apple account and select the `Automatically manage signing` option.\
Run the simulator and then the MacBook `Finder / Applications / Utilities / Console` app.\
Select the simulator in the left hand panel then run the mobile code sample.\
Filter the console tool's output on `mobile.authsamples.com`, to see `swcd` output like this:

```text
Failed to verify server trust <SecTrustRef: 0x60000333c000> for task AASA-E2CD71C8-858B-40EB-A4FA-9062B57F0F25
{ domain: mobile.authsamples.com?mode=developer, bytes: 0, route: .wk }: Error Domain=SWCErrorDomain Code=100
"Disallowed trust result type." UserInfo={Line=174, Function=-[SWCSecurityGuard verifyTrust:allowInstalledRootCertificates:error:], NSDebugDescription=Disallowed trust result type., TrustResultType=5}
```

To resolve the problem, the simulator must trust the SSL certificate generated by the `run.sh` script.\
You can use the HTTP download technique explained in my [iOS HTTPS Debugging](https://apisandclients.com/posts/ios-https-debugging) blog post.\
These steps make the root certificate authority for `https://mobile.authsamples.com` trusted on a simulator:

```text
- git clone https://github.com/gary-archer/oauth.websample1
- cp DevelopmentWebServer/certs/mobile.authsamples.ca.pem ./oauth.websample1/spa/rootca.crt
- cd oauth.websample1/api
- npm install
- npm start
- Get the local computerâ€™s IP address, such as 192.168.42.37
- On the simulator, run the Safari browser and browse to a URL such as http://192.168.42.37/spa/rootca.pem
- Allow the configuration profile to be downloaded
- On the simulator, navigate to Settings / General / VPN & Device Management and install the profile
- On the simulator, navigate to Settings / General / About and trust the root certificate
- Browse to https://mobile.authsamples.com/.well-known/apple-app-site-association in Safari on the simulator
```

Once the certificate is trusted, run the mobile code sample again.\
On the MacBook, filter the console tool's output on `mobile.authsamples.com`, to see `swcd` output like this:

```text
Successfully got credential for challenge <NSURLAuthenticationChallenge: 0x60000003c170> for task
AASA-DAC8FEFE-7863-4D2A-93BD-8282A546DC41 { domain: mobile.authsamples.com?mode=developer, bytes: 0, route: .wk }
```

The code sample should then work in the correct way, but only on simulators.\
To test on real devices you would need to provide your own infrastructure.
